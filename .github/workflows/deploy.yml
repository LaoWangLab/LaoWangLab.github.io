name: deploy

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 */6 * *'
  push:
    branches:
      - "master"
    paths:
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch slides from external repository
        run: |
          set +e
          echo "Fetching slides from external repository..."

          SLIDES_DIR="slides"
          SLIDES_REPO="https://github.com/${{ github.repository_owner }}/$SLIDES_DIR"
          TEMP_DIR="temp_slides"

          rm -rf "$SLIDES_DIR"
          mkdir -p "$SLIDES_DIR"

          if git clone --depth 1 "$SLIDES_REPO.git" "$TEMP_DIR" 2>/dev/null; then
            echo "Successfully cloned slides repository"
          else
            echo "Warning: Slides repository not found or not accessible. Creating placeholder..."
            echo '[]' > "$SLIDES_DIR/slides-data.json"
            exit 0
          fi

          echo '[' > "$SLIDES_DIR/slides-data.json"
          FIRST_ENTRY=true

          for date_dir in "$TEMP_DIR"/*; do
            if [ -d "$date_dir" ]; then
              dirname=$(basename "$date_dir")

              if [[ $dirname =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                echo "Processing slides for date: $dirname"

                if [ -f "$date_dir/index.html" ]; then
                  echo "Found index.html for $dirname"

                  mkdir -p "$SLIDES_DIR/$dirname"

                  cp "$date_dir/index.html" "$SLIDES_DIR/$dirname/index.html"

                  title="Presentation"

                  if grep -q "<title>" "$date_dir/index.html"; then
                    title=$(grep -o '<title>[^<]*</title>' "$date_dir/index.html" | sed 's/<[^>]*>//g' | head -1)
                  fi

                  if [ "$FIRST_ENTRY" = false ]; then
                    echo ',' >> "$SLIDES_DIR/slides-data.json"
                  else
                    FIRST_ENTRY=false
                  fi

                  cat >> "$SLIDES_DIR/slides-data.json" <<EOF
            {
              "date": "$dirname",
              "title": "$title"
            }
          EOF
                else
                  echo "Warning: No index.html found in $dirname, skipping..."
                fi
              fi
            fi
          done

          echo '' >> "$SLIDES_DIR/slides-data.json"
          echo ']' >> "$SLIDES_DIR/slides-data.json"

          rm -rf "$TEMP_DIR"

          if command -v jq &> /dev/null; then
            jq . "$SLIDES_DIR/slides-data.json" > /dev/null 2>&1 || {
              echo "Warning: Generated JSON is invalid. Creating empty array..."
              echo '[]' > "$SLIDES_DIR/slides-data.json"
            }
          fi

          echo "Slides fetching complete. Found $(grep -c '"date"' "$SLIDES_DIR/slides-data.json" 2>/dev/null || echo 0) presentations."

      - name: Verify generated files
        run: |
          echo "=== Verifying directory structure ==="
          echo "Current directory contents:"
          ls -la
          echo ""
          echo "=== Tree view of important directories ==="
          # Install tree if not available
          which tree || sudo apt-get install -y tree
          echo ""
          echo "Root directory structure:"
          tree -L 2 -a -I '.git|node_modules' .
          echo ""
          echo "=== Slides directory structure ==="
          if [ -d "slides" ]; then
            tree -L 3 slides/
            echo ""
            echo "=== Content of slides-data.json ==="
            cat slides/slides-data.json
          else
            echo "WARNING: slides directory does not exist!"
          fi
          echo ""
          echo "=== Checking critical files ==="
          for file in "index.html" "slides.html" "pub.html" "team.html" "main.js" "assets/tailwind.js" "slides/slides-data.json" "tailwindcss"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists ($(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null) bytes)"
            else
              echo "✗ $file is missing!"
            fi
          done

      - uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      - uses: actions/deploy-pages@v4