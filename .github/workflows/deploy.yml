name: deploy
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 */6 * *'
  push:
    branches:
      - "master"
    paths:
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: npm install --global vercel@latest

      - name: Fetch slides from external repository
        run: |
          set +e
          echo "Fetching slides from external repository..."

          SLIDES_DIR="slides"
          SLIDES_REPO="https://github.com/${{ github.repository_owner }}/$SLIDES_DIR"
          TEMP_DIR="temp_slides"

          rm -rf "$SLIDES_DIR"
          mkdir -p "$SLIDES_DIR"

          if git clone --depth 1 "$SLIDES_REPO.git" "$TEMP_DIR" 2>/dev/null; then
            echo "Successfully cloned slides repository"
          else
            echo "Warning: Slides repository not found or not accessible. Creating placeholder..."
            echo '[]' > "$SLIDES_DIR/slides-data.json"
            exit 0
          fi

          echo '[' > "$SLIDES_DIR/slides-data.json"
          FIRST_ENTRY=true

          for date_dir in "$TEMP_DIR"/*; do
            if [ -d "$date_dir" ]; then
              dirname=$(basename "$date_dir")

              if [ "$dirname" = "example" ]; then
                echo "Skipping example folder..."
                continue
              fi

              if [[ $dirname =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                echo "Processing slides for date: $dirname"

                HAS_HTML=false
                HAS_PDF=false
                PDF_FILE=""

                if [ -f "$date_dir/index.html" ]; then
                  HAS_HTML=true
                fi

                PDF_FILE=$(find "$date_dir" -maxdepth 1 -name "*.pdf" -type f | head -1)
                if [ -n "$PDF_FILE" ]; then
                  HAS_PDF=true
                  PDF_FILENAME=$(basename "$PDF_FILE")
                fi

                if [ "$HAS_HTML" = true ] || [ "$HAS_PDF" = true ]; then
                  mkdir -p "$SLIDES_DIR/$dirname"

                  title="Presentation"

                  if [ "$HAS_HTML" = true ]; then
                    echo "Found index.html for $dirname"
                    cp "$date_dir/index.html" "$SLIDES_DIR/$dirname/index.html"

                    if grep -q "<title>" "$date_dir/index.html"; then
                      title=$(grep -o '<title>[^<]*</title>' "$date_dir/index.html" | sed 's/<[^>]*>//g' | head -1)
                    fi
                  elif [ "$HAS_PDF" = true ]; then
                    title=$(echo "$PDF_FILENAME" | sed 's/\.pdf$//' | tr '_' ' ')
                  fi

                  if [ "$HAS_PDF" = true ]; then
                    echo "Found PDF: $PDF_FILENAME for $dirname"
                    cp "$PDF_FILE" "$SLIDES_DIR/$dirname/$PDF_FILENAME"
                  fi

                  if [ "$FIRST_ENTRY" = false ]; then
                    echo ',' >> "$SLIDES_DIR/slides-data.json"
                  else
                    FIRST_ENTRY=false
                  fi

                  if [ "$HAS_PDF" = true ]; then
                    cat >> "$SLIDES_DIR/slides-data.json" <<EOF
            {
              "date": "$dirname",
              "title": "$title",
              "hasHtml": $HAS_HTML,
              "pdf": "$PDF_FILENAME"
            }
          EOF
                  else
                    cat >> "$SLIDES_DIR/slides-data.json" <<EOF
            {
              "date": "$dirname",
              "title": "$title",
              "hasHtml": $HAS_HTML
            }
          EOF
                  fi
                else
                  echo "Warning: No index.html or PDF found in $dirname, skipping..."
                fi
              fi
            fi
          done

          echo '' >> "$SLIDES_DIR/slides-data.json"
          echo ']' >> "$SLIDES_DIR/slides-data.json"

          rm -rf "$TEMP_DIR"
          if command -v jq &> /dev/null; then
            jq . "$SLIDES_DIR/slides-data.json" > /dev/null 2>&1 || {
              echo "Warning: Generated JSON is invalid. Creating empty array..."
              echo '[]' > "$SLIDES_DIR/slides-data.json"
            }
          fi

          echo "Slides fetching complete. Found $(grep -c '"date"' "$SLIDES_DIR/slides-data.json" 2>/dev/null || echo 0) presentations."

      - name: Build for Vercel
        run: |
          mkdir -p .vercel/output/static
          cp -r * .vercel/output/static/ 2>/dev/null || true

          cat > .vercel/output/config.json <<EOF
          {
            "version": 3,
            "routes": [
              {
                "handle": "filesystem"
              }
            ]
          }
          EOF

          echo "Build complete. Files prepared in .vercel/output/"

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}